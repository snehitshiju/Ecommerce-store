<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Store Management</title>
    <!-- Load Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Load Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f3f5;
        }
        .sidebar {
            height: 100vh;
            background-color: #343a40; /* Dark sidebar */
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .nav-link {
            color: #ccc;
            padding: 15px 20px;
        }
        .nav-link:hover, .nav-link.active {
            background-color: #8a2be2; /* Admin purple */
            color: white;
            border-radius: 0;
        }
        .card-header {
            background-color: #fff;
            font-weight: 700;
            border-bottom: 2px solid #8a2be2;
        }
        .stat-card {
            border-left: 5px solid #8a2be2;
        }
        /* Custom form styling */
        #productFormContainer {
            border: 1px solid #8a2be2;
            border-radius: 8px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div id="alertArea"></div>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <h3 class="text-white text-center py-4 border-bottom" style="background-color: #8a2be2;">Admin Panel</h3>
        <ul class="nav flex-column">
            <li class="nav-item">
                <!-- Dashboard link removed from display, but retained for logic if needed -->
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showView('products')">
                    <i class="bi bi-box-seam me-2"></i> Product Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showView('orders')">
                    <i class="bi bi-receipt me-2"></i> Order Review
                </a>
            </li>
        </ul>
        <div class="mt-5 pt-5 px-3">
            <button class="btn btn-outline-danger w-100" onclick="adminLogout()">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Products Management View -->
        <div id="products-view" class="view">
            <h2 class="mb-4">Product Management</h2>
            
            <!-- Product Form (Create/Edit) -->
            <div id="productFormContainer" class="mb-5">
                <h4 id="productFormHeader" class="mb-3 text-primary">Add New Product</h4>
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="productName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="col-md-3">
                            <label for="productPrice" class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" id="productPrice" required>
                        </div>
                        <div class="col-md-3">
                            <label for="productCategory" class="form-label">Category</label>
                            <select id="productCategory" class="form-select" required>
                                <option value="" disabled selected>Select Category</option>
                                <!-- Categories populated by JS -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="productImage" class="form-label">Image URL</label>
                            <input type="url" class="form-control" id="productImage">
                        </div>
                        <div class="col-md-6">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea id="productDescription" class="form-control" rows="1"></textarea>
                        </div>
                        <div class="col-12 mt-4 text-end">
                            <button type="submit" id="productFormSubmit" class="btn btn-primary">Save Product</button>
                            <button type="button" id="productFormCancel" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Product List Table -->
            <h4 class="mb-3">Inventory List</h4>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productListBody">
                        <!-- Products loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Review View -->
        <div id="orders-view" class="view" style="display: none;">
            <h2 class="mb-4">Order Review</h2>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th> <!-- NEW COLUMN HEADER -->
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="orderListBody">
                        <!-- Orders loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">Order #<span id="modalOrderId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Items:</h6>
                    <ul id="modalOrderItems" class="list-group mb-3">
                        <!-- Items list -->
                    </ul>
                    <p><strong>Total:</strong> <span id="modalOrderTotal"></span></p>
                    <p><strong>Status:</strong> <span id="modalOrderStatus"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        const ADMIN_TOKEN_KEY = 'adminToken';
        const ADMIN_DATA_KEY = 'adminUser';
        const CATEGORIES = ['Groceries', 'Kitchen utensils', 'Foood and beverage', 'Stationary', 'Electronics', 'Home appliances', 'Fashion dresses'];

        let currentProducts = []; 
        let currentOrders = [];

        // --- Utility Functions ---

        function formatPrice(price) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(price || 0);
        }

        function showAlert(message, type) {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show fixed-top mt-3 mx-auto" role="alert" style="width: 400px; z-index: 1060;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            document.getElementById('alertArea').appendChild(wrapper);
            setTimeout(() => wrapper.remove(), 5000);
        }

        function checkAuth() {
            const token = localStorage.getItem(ADMIN_TOKEN_KEY);
            if (!token) {
                window.location.href = 'adminlogin.html';
                return false;
            }
            return token;
        }

        function adminLogout() {
            localStorage.removeItem(ADMIN_TOKEN_KEY);
            localStorage.removeItem(ADMIN_DATA_KEY);
            window.location.href = 'adminlogin.html';
        }

        // --- View Switching ---

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId + '-view').style.display = 'block';

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[onclick*="${viewId}"]`).classList.add('active');

            if (viewId === 'products') fetchProducts();
            if (viewId === 'orders') fetchOrders();
        }

        // --- API & Data Fetching ---

        async function authenticatedFetch(url, options = {}) {
            const token = checkAuth();
            if (!token) throw new Error("Authentication failed.");

            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };

            options.headers = {
                ...defaultHeaders,
                ...options.headers
            };

            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                adminLogout(); // Force logout on auth failure
                return;
            }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Server error.' }));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        // --- 2. Product Management ---

        function populateCategoryDropdown() {
            const select = document.getElementById('productCategory');
            CATEGORIES.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
        }

        async function fetchProducts() {
            try {
                // Fetches ALL products using the generic /api/products route
                const products = await authenticatedFetch(`${API_BASE_URL}/products`); 
                if (!products) return;
                currentProducts = products;
                renderProductList(products);
            } catch (error) {
                showAlert(`Failed to load products: ${error.message}.`, 'danger');
            }
        }

        function renderProductList(products) {
            const tbody = document.getElementById('productListBody');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p._id.substring(0, 5)}...</td>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td>${formatPrice(p.price)}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" onclick="editProduct('${p._id}')"><i class="bi bi-pencil"></i> Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')"><i class="bi bi-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function saveProduct(event) {
            event.preventDefault();
            const form = event.target;
            const isEditing = !!document.getElementById('productId').value;
            const id = document.getElementById('productId').value;

            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                image_url: document.getElementById('productImage').value,
                description: document.getElementById('productDescription').value,
            };

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing ? `${API_BASE_URL}/products/${id}` : `${API_BASE_URL}/products`;

            try {
                const result = await authenticatedFetch(url, {
                    method: method,
                    body: JSON.stringify(productData)
                });
                
                if (result) {
                    showAlert(`Product ${isEditing ? 'updated' : 'created'} successfully!`, 'success');
                    form.reset();
                    document.getElementById('productFormCancel').click();
                    fetchProducts();
                }
            } catch (error) {
                showAlert(`Error saving product: ${error.message}`, 'danger');
            }
        }

        function editProduct(id) {
            const product = currentProducts.find(p => p._id === id);
            if (!product) return;

            document.getElementById('productId').value = product._id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productImage').value = product.image_url || product.image || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productFormHeader').textContent = `Edit Product: ${product.name}`;
            document.getElementById('productFormSubmit').textContent = 'Update Product';
        }

        async function deleteProduct(id) {
            if (!confirm("Are you sure you want to delete this product?")) return;

            try {
                await authenticatedFetch(`${API_BASE_URL}/products/${id}`, { method: 'DELETE' });
                showAlert('Product deleted successfully!', 'success');
                fetchProducts();
            } catch (error) {
                showAlert(`Error deleting product: ${error.message}`, 'danger');
            }
        }
        
        // --- 3. Order Management ---

        async function fetchOrders() {
            try {
                // Fetches ALL orders 
                const orders = await authenticatedFetch(`${API_BASE_URL}/orders`); 
                if (!orders) return;
                currentOrders = orders;
                renderOrderList(orders, false);
            } catch (error) {
                showAlert(`Failed to load orders: ${error.message}. Ensure backend /api/orders route is working.`, 'danger');
            }
        }

        function renderOrderList(orders, isQuickView = false) {
            const targetContainer = isQuickView ? document.getElementById('quickOrderList') : document.getElementById('orderListBody');
            
            // Limit to 5 for quick view (retained for quick view logic, but not displayed here)
            const listToRender = orders; 

            const htmlContent = listToRender.map(o => {
                // Get the name and quantity of the first item for display
                const firstItem = o.items && o.items.length > 0 ? o.items[0] : null;
                const itemDisplay = firstItem ? `${firstItem.name} (${firstItem.quantity}x)` : 'N/A';

                return `
                <tr class="${isQuickView && (o.status === 'Paid' || o.status === 'Processing') ? 'table-warning' : ''}">
                    <td>${o._id ? o._id.substring(0, 5) : 'N/A'}...</td>
                    <td>${o.customerName || 'N/A'}</td>
                    <td>${itemDisplay}</td> <!-- ITEMS COLUMN -->
                    <td>${formatPrice(o.totalAmount)}</td>
                    <td>${new Date(o.orderDate).toLocaleDateString()}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateOrderStatus('${o._id}', this.value)">
                            <option value="Paid" ${o.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Processing" ${o.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Shipped" ${o.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${o.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${o._id}')">View</button>
                    </td>
                </tr>
            `}).join('');

            if (isQuickView) {
                // Quick view structure (table wrapper needed)
                targetContainer.innerHTML = `<table class="table table-striped table-sm">${htmlContent}</table>`;
            } else {
                // Full view structure (just rows/content)
                targetContainer.innerHTML = htmlContent;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Assumes backend has a route like PUT /api/orders/:id
                await authenticatedFetch(`${API_BASE_URL}/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                showAlert(`Order ${orderId.substring(0, 5)} updated to ${newStatus}.`, 'success');
                // Re-fetch data to update both lists
                fetchOrders();
            } catch (error) {
                showAlert(`Error updating status: ${error.message}.`, 'danger');
            }
        }

        function viewOrderDetails(orderId) {
            const order = currentOrders.find(o => o._id === orderId);
            if (!order) return;

            document.getElementById('modalOrderId').textContent = order._id.substring(0, 10);
            document.getElementById('modalOrderTotal').textContent = formatPrice(order.totalAmount);
            document.getElementById('modalOrderStatus').textContent = order.status;
            
            const itemsList = document.getElementById('modalOrderItems');
            itemsList.innerHTML = order.items.map(item => `
                <li class="list-group-item d-flex justify-content-between">
                    <span>${item.name}</span>
                    <span class="badge bg-secondary">${item.quantity}x</span>
                </li>
            `).join('');

            const detailModal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            detailModal.show();
        }

        // --- Initialization ---

        window.onload = () => {
            if (!checkAuth()) return;
            
            // Set up event listeners
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('productFormCancel').addEventListener('click', (e) => {
                // Cancel button clears form and switches back to Add mode
                e.preventDefault();
                e.target.form.reset();
                document.getElementById('productId').value = '';
                document.getElementById('productFormHeader').textContent = 'Add New Product';
                document.getElementById('productFormSubmit').textContent = 'Save Product';
            });
            
            populateCategoryDropdown();
            showView('products'); // Start on Product Management view
        };
    </script>
</body>
</html>